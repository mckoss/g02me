{% extends "master.html" %}
{% load humanize %}
{% load custom %}

{% block subTitle %}{{map.title|escape}}{% endblock %}

{% block script %}
// Google Ad Manager
msLoaded = new Date().getTime();
Go2.SetCSRF("{{csrf}}");
Go2.map = {{map.JSON|JSON}};

try
	{
	GA_googleAddSlot("{{ad_publisher_id}}", "map-bottom");
	GA_googleFetchAds();
	}
catch (e) {}

function BeforeUnload(evt)
{
	msUnloading = new Date().getTime();
	
	if (msUnloading - msLoaded < 5000)
		{
		evt = evt || window.event || {};
		evt.returnValue = "Click CANCEL to keep the {{site_name}} header at the top of the page.";
		return evt.returnValue;
		}
}

window.onbeforeunload = BeforeUnload;

function Loaded()
{
	Go2.BindDOM();

	if (Go2.parts["username"])
		{
		Go2.AddEventFn(Go2.parts["username"], "keydown", function(evt) {
			if (evt.keyCode == 13)
				Go2.SetUsername(Go2.parts["username"].value);
			});
		}

	Go2.parts["comment"].focus();

	Go2.AddEventFn(Go2.parts["comment"], "keydown", KeyDownComment);
	
	Go2.AddEventFn(Go2.parts["content-iframe"], "load", OnNavigate);
	
	OnResize();
	Go2.InitPanels();
	Go2.AddEventFn(window, "resize", OnResize);
	
	Go2.UpdatePrivacy();
	Go2.DOM.ScrollToBottom(Go2.parts["comments"]);
	Go2.CalcLatest();
}

function OnResize()
{
	var rcWindow = Go2.DOM.RcWindow();
	var dyMax = rcWindow[3] - rcWindow[1];

	var ptComments = Go2.DOM.PtClient(Go2.parts["comments"]);
	var ptCommentForm = Go2.DOM.PtSize(Go2.parts["comment-form"]);
	var ptSponsor = Go2.DOM.PtSize(Go2.parts["sponsor-panel"]);
	var dyComments = dyMax - ptCommentForm[1] - ptSponsor[1] - ptComments[1];
	
	// Info bar needs to be taller than the window - force a scroll bar
	if (dyComments < 120)
		{
		dyMax += 120 - dyComments;
		dyComments = 120;
		}

	var ptContent = Go2.DOM.PtClient(Go2.parts["content"]);
	Go2.parts["content"].style.height = (dyMax - ptContent[1]) + "px";
	Go2.parts["info"].style.height = (dyMax-32) + "px";
	Go2.parts["border-v"].style.height = (dyMax-32) + "px";
	Go2.parts["comments"].style.height = dyComments + "px";
}

// Ignore the first load of the frame - that's likely our initial link (or just reset to initial link)
var fResetFrame = true; 

function OnNavigate()
{
	// Can't get URL of user-navigated frame due to browser security.
	if (fResetFrame)
		{
		fResetFrame = false;
		return;
		}
	
	Go2.parts["linkLabel"].innerHTML = "Original Link";
}

function ResetFrame()
{
	msLoaded = new Date().getTime();
	Go2.parts["content-iframe"].src = "{{map.Href}}";
	fResetFrame = true;

	Go2.parts["linkLabel"].innerHTML = "Link";
}

function Click()
{
	msLoaded = 0;
}

function PostComment()
{
	Go2.PostComment("{{map.GetId}}", Go2.parts["username"] ? Go2.parts["username"].value : '', Go2.parts["comment"].value);
}

function KeyDownComment(evt)
{
	if (evt.keyCode == 13)
		{
		PostComment();
		evt.preventDefault();
		}
}

Go2.AddEventFn(window, "click", Click, true)
{% endblock %}

{% block body %}
<div id="title" class="title">
	<a target="_top" href="/" title="{{site_name}} Home | Popular Pages">
		<img class="title-logo" src="/images/title-logo.png"/>
	</a>
	<a href="{{map.Href}}" title="Close Frame"><div class="close-box"></div></a>
	
	<div class="title-account">
	{% if username %}
		<div style="margin-top: 4px;">
			<a href="/user/{{username}}" title="{{username}}'s activity">{{username}}</a>
			{% if profile %}
				(<a href="/profile/" title="{{username}}'s profile">Profile</a>)
			{% else %}
				(<a href="/profile/" title="Your nickname is temporary until you create a (free) account.">Create Account</a>)
			{% endif %} |
			<a href="#" onclick="Go2.SetUsername('');return false;">Sign out</a>
		</div>
	{% else %}
		<div id="sign-in">
		    <label for="username">Nickname: </label>
		    <input maxlength="20" style="width:70px;" type="text" id="username" name="username"/>
			<input onclick="Go2.SetUsername(txtUsername.value);" style="width:70px;" type="button" value="Set It"/>
		</div>
	{% endif %}
	</div>

	<p class="link">
		<span id="linkLabel">Link</span>:
		<a onclick="ResetFrame();return false;" href="{{map.Href}}" alt="{{map.title|escape}}" title="{{map.title|escape}}">
			{{map.url|escape}}
		</a>
	</p>
</div>

<div id="info" class="info">

	<!-- Statistics Panel -->
	<div id="stats-panel" class="panel">
		<div class="expander expanded"></div>
		<div style="position:relative;" class="panel-body">
			<div class="open-star" title="Make Link a Favorite"></div>
			<div class="creator">
			{% if map.Creator %}
				<a href="/user/{{map.Creator}}">
					<img class="profile-med" src="/user/{{map.Creator}}/picture_med">
				</a><br/>
				<a href="/user/{{map.Creator}}">{{map.Creator}}</a>
			{% else %}
				<img class="profile-med" src="/images/picture_med.png">
			{% endif %}
			</div>
			<div class="content">
				<p>Created: {{map.dateCreated|Age}}</p>
				<p>Viewers: {{map.Uniques|intcomma}}</p>
				<p>Tags: 
				{% for tag in TopTags %}
					<a target="_top" href="/tag/{{tag}}" title="Recently popular | {{tag}}">{{tag|escape}}</a>{% if not forloop.last %}, {% endif %}
				{% endfor %}
				</p>
			</div>
			<div style="margin: 5px 5px 2px 0;text-align:right;">
				<a href="#">Report Page</a>
				{% if is_admin %}
					| <a href="#" onclick="Go2.BanishId('{{map.GetId}}', '{{map.Banished}}'=='False'); return false;">{% if map.Banished%}Un-{% endif %}Ban</a>
				{% endif %}
			</div>
			<div style="margin: 5px 5px 2px 0;text-align:right;">
				<img class="clickable" onclick="Go2.TogglePrivate('{{map.GetId}}', '{{username}}');return false;" id="private-image" src="/images/lock_open.png">
				<a href="mailto:?subject=Go2.me at {{map.title|escape}}&body=I've shared a link with you at http://{{site_host}}/{{map.GetId}}"
				   title="Send Link by Email">
					<img src="/images/email.png">
				</a>
				<a target="_blank"
				   href="http://www.facebook.com/share.php?u=http://{{site_host}}/{{map.GetId}}"
				   onclick="Go2.FacebookShare('http://{{site_host}}/{{map.GetId}}', '{{map.title|escape}}');return false;"
				   title="Share Link on Facebook">
					<img src="/images/facebook.png">
				</a>
				<a target="_blank"
				   href="http://twitter.com/home?source={{twitter_source}}&status={{map.TweetText}}"
				   title="Share Link on Twitter">
					<img src="/images/twitter-logo.png">
				</a>
			</div>
		</div>
	</div>
	
	<!-- Chat/Comments Panel -->
	<div id="chat-panel" class="panel">
		<div class="panel-header">
			<div class="expander expanded"></div>
			<span id="chat-title">Chat</span>
		</div>
		<div class="panel-body">
			<!-- Public comments (only) are dumped in page for search engines -->
			<div id="comments" class="comments">
				{% for comment in map.Comments %}
				<p id="cmt_{{comment.ID}}">
			    {% if comment.username %}<a target="_top" href="/user/{{comment.username}}" title="{{comment.username}}'s activity">{{comment.username}}</a>:{% endif %}
			    {{comment.comment|escape|urlizecomment}}
			    {% if comment.tags %}
			    	[{% for tag in comment.TagList %}<a target="_top" href="/tag/{{tag}}" title="{{tag}} pages">{{tag}}</a>{% if not forloop.last %}, {% endif %}{% endfor %}]
			    {% endif %}
			    - {{ comment.dateCreated|Age }}
			    {% if comment.AllowDelete %}
			    <img class="x" onclick="Go2.DeleteComment({{comment.ID}}, '{{comment.DelKey}}');" src="/images/x.png"/>
			    {% endif %}
			    </p>
				{% endfor %}
			</div>
			
			<div id="comment-form" class="comment-form">
				<div class="divider-h"></div>
					<textarea id="comment" class="comment" tabindex="2"></textarea>
					<input onclick="PostComment();" type="button" value="Post" tabindex="3"/>
				<p style="clear:left;" class="help">Comment format: "nickname: text of your comment [tag1, tag2, ...]"</p>
			</div>
		</div>
	</div>

	<!-- Sponsor Panel -->
	<div id="sponsor-panel" class="panel">
		<div class="panel-header">
			<div onclick="Go2.TogglePanel('sponsor-panel');return false;" class="expander expanded"></div>
			Sponsored By
		</div>
		<div class="panel-body">
			<div style="height:250px">
				<script>try {GA_googleFillSlot("map-bottom");} catch (e) {}</script>
			</div>
			<div style="text-align:center;">
				<a href="http://code.google.com/p/g02me/wiki/AboutUs">About {{site_name}}</a> |
				<a href="http://blog.go2.me">Blog</a> |
				<a href="http://getsatisfaction.com/g02me/products/g02me_g02me">Feedback</a>
			</div>
		</div>
	</div>

</div> <!-- info sidebar -->

<div id="border-v" style="position:absolute;top:32;left:300px;height:3000px;" class="border-v"></div>

<div id="content">
	<iframe id="content-iframe" name="content-frame" src="{{map.Href}}"/>
		Your browser does not support frames.  You can visit the page, "" by clicking this link
		<a href="{{map.Href}}" alt="{{map.title|escape}}" title="{{map.title|escape}}">{{map.title|escape}}</a>.
	</iframe>
</div>
{% endblock %}
