<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>G02ME Unit Test</title>
<script src="unit.js"></script>
<script src="firebug/firebugx.js"></script>
</head>
<body onload="ts.Run();ts.Report();">
<h1><script>document.write(document.title);</script></h1>

<script>
var ts = new UT.TestSuite();
ts.DWOutputDiv();

ts.AddTest("Map", function(ut)
{
	var objInit;

	ut.AsyncSequence([
		function(ut)
			{
			new UT.ScriptData("/map/").Call({url:"http://google.com"}, function(obj) {
				ut.AssertContains(obj, {status:"OK", url:"http://google.com", title:"http://google.com"});
				ut.AssertType(obj.created, Date);
				objInit = obj;
				ut.NextFn();
				});
			},
		function(ut)
			{
			new UT.ScriptData("/map/").Call({url:"http://google.com"}, function(obj) {
				ut.AssertContains(obj,
					{status:"OK", url:"http://google.com", id:objInit.id, viewed:objInit.viewed, shared:objInit.shared+1});
				ut.NextFn();
				});
			},
		function(ut)
			{
			new UT.ScriptData("/map/").Call({url:"google.com"}, function(obj) {
				ut.AssertContains(obj,
					{status:"OK", url:"http://google.com", id:objInit.id, viewed:objInit.viewed, shared:objInit.shared+2});
				ut.NextFn();
				});
			},
		function(ut)
			{
			new UT.ScriptData("/map/").Call({url:" http://google.com "}, function(obj) {
				ut.AssertContains(obj,
					{status:"OK", url:"http://google.com", id:objInit.id, viewed:objInit.viewed, shared:objInit.shared+3});
				ut.NextFn();
				});
			},
		function(ut)
			{
			var frame = document.createElement("iframe");
			frame.src = "/" + objInit.id;
			document.body.appendChild(frame);
			tm = new UT.Timer(ut.NextFn.FnMethod(ut), 500).Active(true);
			},
		function(ut)
			{
			new UT.ScriptData("/map/").Call({url:"http://google.com"}, function(obj) {
				ut.AssertContains(obj,
					{status:"OK", url:"http://google.com", id:objInit.id, viewed:objInit.viewed+1, shared:objInit.shared+4});
				ut.NextFn();
				});
			},
		function(ut)
			{
			new UT.ScriptData("/map/").Call({url:"https://google.com"}, function(obj) {
				ut.AssertContains(obj,
					{status:"OK", url:"https://google.com"});
				ut.NextFn();
				});
			}
		]);
}).Async(true);

ts.AddTest("Errors", function(ut)
{
	ut.AsyncSequence([
		function (ut)
			{
			new UT.ScriptData("/map/").Call({url:""}, function (obj) {
				ut.AssertContains(obj, {status:"Fail"});
				ut.NextFn();
				});
			},
		function (ut)
			{
			new UT.ScriptData("/map/").Call({url:"http://g02.me"}, function (obj) {
				ut.AssertContains(obj, {status:"Fail/Domain"});
				ut.NextFn();
				});
			},
		function (ut)
			{
			new UT.ScriptData("/map/").Call({url:"http://www.g02.me"}, function (obj) {
				ut.AssertContains(obj, {status:"Fail/Domain"});
				ut.NextFn();
				});
			},
		function (ut)
			{
			new UT.ScriptData("/map/").Call({url:"script://google.com"}, function (obj) {
				ut.AssertContains(obj, {status:"Fail"});
				ut.NextFn();
				});
			}
		]);
}).Async(true);

ts.AddTest("Info", function(ut)
{
	var objInit;

	ut.AsyncSequence([
		function(ut)
			{
			new UT.ScriptData("/map/").Call({url:"http://google.com"}, function(obj) {
				ut.AssertContains(obj, {status:"OK", url:"http://google.com"});
				objInit = obj;
				ut.NextFn();
				});
			},
		function (ut)
			{
			new UT.ScriptData("/info/" + objInit.id).Call({}, function (obj) {
				ut.AssertContains(obj, {status:"OK", url:"http://google.com"});
				ut.NextFn();
				});
			},
		function (ut)
			{
			new UT.ScriptData("/info/9999").Call({}, function (obj) {
				ut.AssertContains(obj, {status:"Fail/NotFound"});
				ut.NextFn();
				});
			}
		]);
}).Async(true);

ts.AddTest("Comment", function(ut)
{
	var objInit;
	var cComment;

	ut.AsyncSequence([
		function(ut)
			{
			new UT.ScriptData("/map/").Call({url:"http://google.com"}, function(obj) {
				ut.AssertContains(obj, {status:"OK", url:"http://google.com"});
				objInit = obj;
				ut.NextFn();
				});
			},
		function(ut)
			{
			new UT.ScriptData("/comment/").Call({id:objInit.id, comment:"hello"}, function (obj) {
				ut.AssertContains(obj, {status:"OK", url:"http://google.com"});
				ut.AssertContains(obj.comments[0], {comment:"hello"});
				ut.AssertType(obj.comments[0].user, "number");
				cComment = obj.comments.length;
				ut.NextFn();
				});
			},
		function(ut)
			{
			new UT.ScriptData("/info/" + objInit.id).Call({}, function (obj) {
				ut.AssertContains(obj, {status:"OK", url:"http://google.com"});
				ut.AssertContains(obj.comments[0], {comment:"hello"});
				ut.AssertEq(obj.comments.length, cComment);
				ut.NextFn();
				});
			},
		function(ut)
			{
			new UT.ScriptData("/comment/").Call({id:objInit.id, comment:"mckoss :  This is a test  [tag1,  tag2]"}, function (obj) {
				ut.AssertContains(obj, {status:"OK", url:"http://google.com"});
				ut.AssertContains(obj.comments[0], {comment:"This is a test", tags:"tag1,tag2", user:"mckoss"});
				ut.AssertType(obj.comments[0].created, Date);
				ut.AssertEq(obj.comments.length, cComment+1);
				ut.NextFn();
				});
			},
		function(ut)
			{
			new UT.ScriptData("/info/" + objInit.id).Call({}, function (obj) {
				ut.AssertContains(obj, {status:"OK", url:"http://google.com"});
				ut.AssertEq(obj.comments.length, cComment+1);
				com = obj.comments[0];
				ut.AssertContains(com, {comment:"This is a test", user:"mckoss", tags:"tag1,tag2"});
				ut.NextFn();
				});
			}
		]);
}).Async(true);

</script>
</body>