<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>G02ME Unit Test</title>
<script src="unit.js"></script>
<script src="firebug/firebugx.js"></script>
</head>
<body onload="ts.Run();ts.Report();">
<h1><script>document.write(document.title);</script></h1>

<script>
var ts = new UT.TestSuite();
ts.DWOutputDiv();

ts.AddTest("Map", function(ut)
{
	var objInit;
	
	ut.AsyncSequence([
		function(ut)
			{
			new UT.ScriptData("/map/").Call({url:"http://google.com"}, function(obj) {
				ut.AssertContains(obj, {status:"OK", url:"http://google.com/", title:"http://google.com/"});
				ut.AssertGT(obj.scores.day, 0);
				ut.AssertType(obj.created, Date);
				objInit = obj;
				ut.NextFn();
				});
			},
		function(ut)
			{
			new UT.ScriptData("/map/").Call({url:"http://google.com?id=2"}, function(obj) {
				ut.AssertContains(obj, {status:"OK", url:"http://google.com/?id=2", title:"http://google.com/?id=2"});
				ut.AssertNEq(obj.id, objInit.id);
				ut.NextFn();
				});
			},
		function(ut)
			{
			new UT.ScriptData("/lookup/").Call({url:"http://google.com"}, function(obj) {
				ut.AssertContains(obj,
					{status:"OK", url:"http://google.com/", id:objInit.id, viewed:objInit.viewed, shared:objInit.shared});
				ut.NextFn();
				});
			},
		function(ut)
			{
			new UT.ScriptData("/map/").Call({url:"http://google.com"}, function(obj) {
				ut.AssertContains(obj,
					{status:"OK", url:"http://google.com/", id:objInit.id, viewed:objInit.viewed, shared:objInit.shared});
				ut.NextFn();
				});
			},
		function(ut)
			{
			new UT.ScriptData("/map/").Call({url:"google.com"}, function(obj) {
				ut.AssertContains(obj,
					{status:"OK", url:"http://google.com/", id:objInit.id, viewed:objInit.viewed, shared:objInit.shared});
				ut.NextFn();
				});
			},
		function(ut)
			{
			new UT.ScriptData("/map/").Call({url:" http://google.com "}, function(obj) {
				ut.AssertContains(obj,
					{status:"OK", url:"http://google.com/", id:objInit.id, viewed:objInit.viewed, shared:objInit.shared});
				ut.NextFn();
				});
			},
		function(ut)
			{
			var frame = document.createElement("iframe");
			frame.src = "/" + objInit.id;
			frame.style.width = "800px";
			document.body.appendChild(frame);
			tm = new UT.Timer(ut.NextFn.FnMethod(ut), 500).Active(true);
			},
		function(ut)
			{
			new UT.ScriptData("/map/").Call({url:"http://google.com"}, function(obj) {
				ut.AssertContains(obj,
					{status:"OK", url:"http://google.com/", id:objInit.id, viewed:objInit.viewed, shared:objInit.shared});
				ut.NextFn();
				});
			},
		function(ut)
			{
			new UT.ScriptData("/map/").Call({url:"https://google.com"}, function(obj) {
				ut.AssertContains(obj,
					{status:"OK", url:"https://google.com/"});
				ut.NextFn();
				});
			}
		]);
}).Async(true);

ts.AddTest("Errors", function(ut)
{
	ut.AsyncSequence([
		function (ut)
			{
			new UT.ScriptData("/map/").Call({url:""}, function (obj) {
				ut.AssertContains(obj, {status:"Fail"});
				ut.NextFn();
				});
			},
		function (ut)
			{
			new UT.ScriptData("/map/").Call({url:"http://g02.me"}, function (obj) {
				ut.AssertContains(obj, {status:"Warning/Domain"});
				ut.NextFn();
				});
			},
		function (ut)
			{
			new UT.ScriptData("/map/").Call({url:"http://www.g02.me"}, function (obj) {
				ut.AssertContains(obj, {status:"Fail/Domain"});
				ut.NextFn();
				});
			},
		function (ut)
			{
			new UT.ScriptData("/map/").Call({url:"http://G02.ME"}, function (obj) {
				ut.AssertContains(obj, {status:"Warning/Domain"});
				ut.NextFn();
				});
			},
		function (ut)
			{
			new UT.ScriptData("/map/").Call({url:"http://www.tinyurl.com"}, function (obj) {
				ut.AssertContains(obj, {status:"Fail/Domain"}, "www.tinyurl.com");
				ut.NextFn();
				});
			},
		function (ut)
			{
			new UT.ScriptData("/map/").Call({url:"script://google.com"}, function (obj) {
				ut.AssertContains(obj, {status:"Fail"});
				ut.NextFn();
				});
			},
		function(ut)
			{
			new UT.ScriptData("/lookup/").Call({url:"http://nosuchurl.com"}, function(obj) {
				ut.AssertContains(obj, {status:"Fail/NotFound"});
				ut.NextFn();
				});
			}
		]);
}).Async(true);

ts.AddTest("Info", function(ut)
{
	var objInit;

	ut.AsyncSequence([
		function(ut)
			{
			new UT.ScriptData("/map/").Call({url:"http://google.com"}, function(obj) {
				ut.AssertContains(obj, {status:"OK", url:"http://google.com/"});
				objInit = obj;
				ut.NextFn();
				});
			},
		function (ut)
			{
			new UT.ScriptData("/info/" + objInit.id).Call({}, function (obj) {
				ut.AssertContains(obj, {status:"OK", url:"http://google.com/"});
				ut.NextFn();
				});
			},
		function (ut)
			{
			new UT.ScriptData("/info/9999").Call({}, function (obj) {
				ut.AssertContains(obj, {status:"Fail/NotFound"});
				ut.NextFn();
				});
			}
		]);
}).Async(true);

ts.AddTest("Comment", function(ut)
{
	var objInit;
	var cComment;
	var com;
	var com2;
	var tagUniq;

	ut.AsyncSequence([
		function(ut)
			{
			new UT.ScriptData("/map/").Call({url:"http://google.com"}, function(obj) {
				ut.AssertContains(obj, {status:"OK", url:"http://google.com/"});
				objInit = obj;
				ut.NextFn();
				});
			},
		function(ut)
			{
			new UT.ScriptData("/comment/").Call({id:objInit.id, comment:"hello"}, function (obj) {
				ut.AssertContains(obj, {status:"Fail/Auth"});
				ut.NextFn();
				});
			},
		function(ut)
			{
			new UT.ScriptData("/comment/").Call({id:objInit.id, comment:"hello", apikey:'test-api-key'}, ut.FnWrap(function (obj) {
				ut.AssertContains(obj, {status:"OK", url:"http://google.com/"});
				ut.AssertContains(obj.comments[0], {comment:"hello"});
				cComment = obj.comments.length;
				ut.NextFn();
				}));
			},
		function(ut)
			{
			new UT.ScriptData("/info/" + objInit.id).Call({}, function (obj) {
				ut.AssertContains(obj, {status:"OK", url:"http://google.com/"});
				ut.AssertContains(obj.comments[0], {comment:"hello"});
				ut.AssertEq(obj.comments.length, cComment);
				ut.NextFn();
				});
			},
		function(ut)
			{
			new UT.ScriptData("/comment/").Call({id:objInit.id, force: true, comment:"mckoss :  This is a test  [  ,,tag1,  tag2]", apikey:'test-api-key'}, function (obj) {
				ut.AssertContains(obj, {status:"OK", url:"http://google.com/"});
				ut.AssertContains(obj.comments[0], {comment:"This is a test", tags:"tag1,tag2", user:"mckoss"});
				ut.AssertType(obj.comments[0].created, Date);
				ut.AssertEq(obj.comments.length, cComment+1);
				ut.AssertContains(obj.tags, ["tag1", "tag2"]);
				ut.NextFn();
				});
			},
		function(ut)
			{
			new UT.ScriptData("/info/" + objInit.id).Call({}, function (obj) {
				ut.AssertContains(obj, {status:"OK", url:"http://google.com/"});
				ut.AssertEq(obj.comments.length, cComment+1);
				com = obj.comments[0];
				ut.AssertContains(com, {comment:"This is a test", user:"mckoss", tags:"tag1,tag2"});
				ut.NextFn();
				});
			},
		function(ut)
			{
			tagUniq = "dm-" + Math.floor(Math.random()*1000);
			new UT.ScriptData("/comment/").Call({id:objInit.id, comment:"mckoss :  [" + tagUniq + "]", apikey:'test-api-key'}, function (obj) {
				ut.AssertContains(obj, {status:"OK", url:"http://google.com/"});
				ut.AssertContains(obj.comments[0], {comment:"", user:"mckoss", tags:tagUniq});
				com2= obj.comments[0];
				ut.AssertEq(obj.comments.length, cComment+2);
				ut.AssertContains(obj.tags, ["tag1", "tag2", tagUniq]);
				ut.NextFn();
				});
			},
		function(ut)
			{
			new UT.ScriptData("/comment/delete").Call({cid:com2.cid}, function(obj) {
				ut.AssertContains(obj, {status: "Fail/Auth"});
				ut.NextFn();
				});
			},
		function(ut)
			{
			new UT.ScriptData("/comment/delete").Call({delkey:com2.delkey, apikey:'test-api-key'}, ut.FnWrap(function(obj) {
				ut.AssertEq(obj.comments.length, cComment+1);
				for (var i = 0; i < obj.tags.length; i++)
					ut.AssertNEq(obj.tags[i], tagUniq);
				ut.NextFn();
				}));
			},
		function(ut)
			{
			new UT.ScriptData("/comment/delete").Call({delkey:com.delkey, apikey:'test-api-key'}, function(obj) {
				ut.AssertEq(obj.comments.length, cComment);
				ut.NextFn();
				});
			},
		function(ut)
			{
			new UT.ScriptData("/info/" + objInit.id).Call({}, function (obj) {
				ut.AssertContains(obj, {status:"OK", url:"http://google.com/"});
				ut.AssertEq(obj.comments.length, cComment);
				ut.NextFn();
				});
			}
		]);
}).Async(true);

ts.AddTest("Popular", function(ut)
{
	ut.AsyncSequence([
		function(ut)
			{
			new UT.ScriptData("/").Call({}, ut.FnWrap(function(obj) {
				ut.AssertContains(obj, {status:"OK"});
				ut.Assert(obj.pages.length > 0, "non-empty popular list");
				var url = obj.pages[0];
				for (var prop in {day:0,week:0,month:0,year:0})
					ut.AssertGT(url.scores[prop], 0, prop);
				ut.NextFn();
				}));
			}
		]);
}).Async(true);

ts.AddTest("User", function(ut)
{
	ut.AsyncSequence([
		function(ut)
			{
			new UT.ScriptData("/user/mckoss").Call({}, function(obj) {
				ut.AssertContains(obj, {status:"OK"});
				ut.AssertType(obj.urls, Array);
				ut.Assert(obj.urls.length > 0, "non-empty user list");
				ut.NextFn();
				});
			}
		]);
}).Async(true);

ts.AddTest("Tag", function(ut)
{
	var objInit;

	ut.AsyncSequence([
		function(ut)
			{
			new UT.ScriptData("/lookup/").Call({url:"http://google.com"}, function(obj) {
				ut.AssertContains(obj, {status:"OK", url:"http://google.com/"});
				objInit = obj;
				ut.NextFn();
				});
			},
		function(ut)
			{
			new UT.ScriptData("/comment/").Call({id:objInit.id, comment:"Testing tags [, ,search,, multi word]", apikey:'test-api-key'}, function (obj) {
				ut.AssertContains(obj, {status:"OK", url:"http://google.com/"});
				ut.AssertGT(obj.comments.length, 0);
				ut.AssertContains(obj.comments[0], {comment:"Testing tags", tags: "search,multi-word"});
				ut.AssertContains(obj.tags, ["multi-word", "search"]); 
				ut.NextFn();
				});
			},
		function(ut)
			{
			new UT.ScriptData("/tag/search").Call({}, ut.FnWrap(function (obj) {
				ut.AssertContains(obj, {status:"OK"});
				ut.AssertType(obj.pages, Array);
				ut.AssertGT(obj.pages.length, 0);
				ut.NextFn();
				}));
			},
		function(ut)
			{
			new UT.ScriptData("/tag/no-such-tag").Call({}, ut.FnWrap(function (obj) {
				ut.AssertContains(obj, {status:"OK"});
				ut.AssertType(obj.pages, Array);
				ut.AssertEq(obj.pages.length, 0);
				ut.NextFn();
				}));
			}
		]);
}).Async(true, 5000);

</script>
</body>